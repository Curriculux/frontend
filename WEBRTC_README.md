# WebRTC Video Meeting Implementation

This document describes the custom WebRTC-based video meeting system that replaces the Jitsi integration.

## Features

- **Multi-participant video calls**: Support for multiple users in a single meeting room
- **Camera preview**: See your video before and during the call
- **Audio/Video controls**: Mute/unmute microphone and enable/disable camera
- **Recording functionality**: Host can record meetings and automatically upload to Plone
- **Device switching**: Switch between multiple cameras if available
- **Automatic grid layout**: Video streams arranged in responsive grid
- **Host privileges**: Meeting creator has special controls (recording)
- **Persistent recordings**: Recordings are automatically uploaded to the class in Plone

## Architecture

### Components

1. **Signaling Server** (`src/server/signaling.js`)
   - Socket.IO based WebSocket server
   - Manages room state and participants
   - Facilitates WebRTC signaling between peers
   - Handles recording state synchronization

2. **WebRTC Manager** (`src/lib/webrtc-manager.ts`)
   - Manages peer connections using simple-peer
   - Handles media stream management
   - Implements recording using RecordRTC
   - Manages device switching and stream updates

3. **Meeting Component** (`src/components/webrtc-meeting.tsx`)
   - React component for the meeting UI
   - Video grid layout with participant previews
   - Control bar for audio/video/recording
   - Integration with Plone API for recording uploads

## Setup

1. **Environment Variables**
   Create a `.env.local` file in the frontend directory:
   ```
   NEXT_PUBLIC_SIGNALING_SERVER_URL=http://localhost:3001
   SIGNALING_PORT=3001
   ```

2. **Install Dependencies**
   The required packages are already included:
   - `socket.io` & `socket.io-client`: WebSocket communication
   - `simple-peer`: WebRTC peer connections
   - `recordrtc`: Meeting recording
   - `concurrently`: Run multiple servers

3. **Start Development Servers**
   ```bash
   npm run dev
   ```
   This starts both:
   - Next.js server on http://localhost:3000
   - Signaling server on http://localhost:3001

## Usage

1. **Creating a Meeting**
   - Click "Start Meeting" button in a class or dashboard
   - Configure meeting settings (title, duration, auto-record)
   - Meeting is created in Plone and user is redirected to meeting room

2. **Joining a Meeting**
   - Navigate to `/meeting/{meetingId}`
   - Browser will request camera/microphone permissions
   - Once granted, user automatically joins the room

3. **During the Meeting**
   - Toggle camera/microphone using control buttons
   - Switch cameras if multiple are available
   - Host can start/stop recording
   - View participant count and status

4. **Recording**
   - Only the host (meeting creator) can record
   - Recording captures all participants in grid layout
   - Mixed audio from all participants
   - Automatic upload to Plone when stopped
   - Recordings stored in class meetings folder

## Technical Details

### WebRTC Configuration
- STUN servers: Google's public STUN servers
- TURN server: Public TURN server for NAT traversal
- Video constraints: 720p preferred, adaptive quality
- Audio: Echo cancellation, noise suppression enabled

### Recording Implementation
- Uses RecordRTC for client-side recording
- Creates mixed stream with canvas for video grid
- Audio mixed using Web Audio API
- WebM format, 2.5 Mbps bitrate
- Chunked recording for better memory usage

### Security Considerations
- Meeting IDs are unique and generated by Plone
- Only authenticated users can join meetings
- Students must be enrolled in class to join class meetings
- Host privileges verified on both client and server
- CORS configured for production deployment

## Production Deployment

1. **Signaling Server**
   - Deploy as separate Node.js service
   - Configure proper CORS origins
   - Use HTTPS in production
   - Consider using Redis for multi-instance scaling

2. **TURN Server**
   - Deploy your own TURN server for production
   - Configure with proper credentials
   - Update ICE server configuration

3. **Environment Variables**
   - Update URLs to production domains
   - Ensure HTTPS for all services
   - Configure proper CORS policies

## Troubleshooting

**Camera/Microphone not working**
- Check browser permissions
- Ensure HTTPS in production
- Verify device is not used by another app

**Connection failures**
- Check signaling server is running
- Verify CORS configuration
- Check firewall/NAT settings

**Recording issues**
- Ensure sufficient browser memory
- Check upload size limits
- Verify Plone permissions

**Poor video quality**
- Check network bandwidth
- Reduce participant count
- Lower video resolution in constraints 